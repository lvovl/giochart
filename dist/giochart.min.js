!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd"),require("object-hash")):"function"==typeof define&&define.amd?define(["lodash","react","g2","react-dom","moment","antd","object-hash"],t):"object"==typeof exports?exports.GIO=t(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd"),require("object-hash")):e.GIO=t(e.lodash,e.React,e.g2,e.ReactDOM,e.moment,e.antd,e["object-hash"])}(this,function(e,t,r,a,o,n,i){return function(e){function t(a){if(r[a])return r[a].exports;var o=r[a]={exports:{},id:a,loaded:!1};return e[a].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),o=this&&this.__assign||Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++){t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};t.__esModule=!0;var n=r(2),i=r(3),s=r(4);t.Chart=s.default;var c=r(9);t.ContextListener=c.default;var l=r(13);t.DataSource=l.default;var p=r(11);t.GrTable=p.default;var u=function(e){e||(e="day:8,1");var t=e.split(":"),r=t[0],a=t[1],o=a.split(","),n=o[0],i=o[1];return"day"===r?parseInt(n,10)>7:"abs"===r?parseInt(i,10)-parseInt(n,10)>6048e5:void 0},m=function(e){function t(t){var r=e.call(this,t)||this;return r.state={field:null,order:null},r}return a(t,e),t.prototype.render=function(){var e=this.props,t=n.clone(e.params);if(e.extraColumns&&e.params.attrs&&(e.params.attrs.isAddFakeMetric=!1),this.state.field){var r=n.find(t.metrics,{id:this.state.field});t.orders=[{id:this.state.field,isDim:!r,orderType:"descend"===this.state.order?"desc":"asc"}]}return i.createElement(l.default,{params:t,cacheOptions:e.cacheOptions},i.createElement(c.default,{chartType:e.chartType,colorTheme:e.colorTheme,granularities:e.params.granularities,adjust:e.adjust,extraColumns:e.extraColumns,groupCol:e.groupCol,range:u(e.params.timeRange),sortHandler:this.sortHandler.bind(this)}))},t.prototype.sortHandler=function(e){this.setState(e)},t}(i.Component),h=function(e){if(!e.chartType)return null;var t=e.metrics,r=e.dimensions||[],a=[];if("singleNumber"===e.chartType&&(r="sum"===e.aggregateType?["tm"]:["tm"].concat(r)),["dimensionLine","dimensionVbar"].includes(e.chartType)&&!r.includes("tm")&&(a=a.concat({id:r[0],top:e.top}),r=["tm"].concat(r)),0===r.length&&(r=["bar"===e.chartType?"v":"tm"].concat(r)),r.includes("tm")&&(a=a.concat({id:"tm",interval:e.interval,period:"comparison"===e.chartType?"auto":void 0})),r.length<1||t.length<1)return null;var o,n;"singleNumber"===e.chartType?(o=!0,n=e.aggregateType||"sum"):["bar","abar"].includes(e.chartType)&&(n="sum",o=!1);var i={aggregation:o,aggregator:n,attrs:e.attrs,dimensions:r,filter:e.filter,granularities:a,id:e.id,limit:["bar","abar","table"].includes(e.chartType)?e.top:void 0,metrics:t,orders:e.orders,timeRange:e.timeRange,userTag:e.userTag},s=e.chartType;"line"===s&&e.metrics.length<2&&(s="area"),s.includes("dimension")&&(s=s.replace("dimension","").toLowerCase()),"line"===s&&e.attrs.subChartType&&"seperate"!==e.attrs.subChartType&&(s="area"),"abar"===s&&(s="bar"),"funnel"===s&&(i.type="funnel");var c=e.attrs.subChartType||"dodge";"seperate"===c?c="dodge":"total"===c&&(c="stack");var l=e.attrs.colorTheme;return{adjust:c,chartType:s,params:i,colorTheme:l}};t.convertChartParams=h;var d=function(e){if(e.chartType)return i.createElement(m,o({},e));var t=e.params;e.colorTheme&&(t.attrs.colorTheme=e.colorTheme);var r=h(e.params);return r?(e.groupCol&&(r.params.expanded=!0),i.createElement(m,o({extraColumns:e.extraColumns,groupCol:e.groupCol},r,{cacheOptions:e.cacheOptions}))):i.createElement("p",null,"参数不合法")};t.default=d},function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(5),n=r(2),i=r(3),s=r(6),c=r(7),l=r(8);l.locale("zh-cn");var p=function(e,t){var r=Math.ceil(t/e);return Math.ceil(t/r)},u=function(e){var t={combineMetrics:!0,geom:"line",margin:[10,30,55,70]},r={area:{geom:"area",size:2},bar:{combineMetrics:!1,geom:"interval",label:!0,margin:[20,40,10,10],reflect:"y",transpose:!0},bubble:{geom:"point",pos:"MM",combineMetrics:!1,shape:"circle"},comparison:{geom:"area",pos:"MMD",combineMetrics:!1,hideAxis:!0,tooltipchange:"custom",colorTheme:"252, 95, 58",margin:[10,30,50,50]},dualaxis:{geom:"interval",pos:"MMD",combineMetrics:!1,margin:[10,50,50,50]},funnel:{geom:"line",size:2},line:{geom:"line",size:2},retention:{geom:"line",size:2,counter:"day",margin:[10,30,50,40]},singleNumber:{geom:"area",shape:"smooth",size:2,combineMetrics:!1,axis:!1,tooltip:!1,margin:[0,0,0,0],colorTheme:"252, 95, 58"},vbar:{geom:"interval"}};return n.merge({},t,r[e])},m=function(e){function t(t){var r=e.call(this)||this;r.lastSelectedShape=null;var a=["#5FB6C7","#FFD159","#C9C77C","#FA7413","#D6DCE3","#6F5D45","#FDF0A1","#bf1f41","#A1EBDE","#CBBD8C","#B96285","#8a73c9","#005a03","#320096","#673000","#2d396b"],n="#5FB6C7",i=o.Util.mix(!0,o.Theme,{animate:!1,axis:{bottom:{labels:{autoRotate:!1},title:null},left:{labels:{autoRotate:!1},title:null},right:{labels:{autoRotate:!1},title:null}},colors:{default:a,intervalStack:a},defaultColor:n,legend:{bottom:{dy:20}},shape:{area:{fill:"#5FB6C7"},hollowPoint:{fill:"#5FB6C7"},interval:{fill:"#abce5b",fillOpacity:1},line:{stroke:"#5FB6C7"},point:{fill:"#5FB6C7"}},tooltip:{tooltipMarker:{stroke:"#5FB6C7"}}});return o.Global.setTheme(i),r}return a(t,e),t.prototype.render=function(){return i.createElement("div",{className:"giochart",style:this.props.style})},t.prototype.isValidParams=function(e,t){if("comparison"===e.chartType&&t.length&&!t[0].tm_)return!1;if("bar"===e.chartType){var r=n.find(e.columns,{isDim:!0});return"tm"!==r.id}return!0},t.prototype.componentWillReceiveProps=function(e){if(!n.isEmpty(e.source)){var t=e.source;if(this.isValidParams(e.chartParams,e.source))if(n.isEmpty(e.selected))n.isEqualWith(this.props.chartParams,e.chartParams,JSON.stringify)?n.isEqualWith(t,this.props.source,JSON.stringify)||(this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML=""),this.drawChart(e.chartParams,t)):(this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML=""),this.drawChart(e.chartParams,t));else{var r=n.map(n.filter(e.chartParams.columns,{isDim:!0}),"id"),a=n.filter(e.selected,function(e){return n.isEmpty(n.pick(e,r))});if(n.isEmpty(a))return;var o=n.filter(t,function(e){return n.some(a,function(t){return n.isMatch(e,t)})});this.changeData(o||t)}}},t.prototype.changeData=function(e){if(this.chart){var t=this.props.chartParams,r=u(t.chartType),a=new o.Frame(e),i=n.map(n.filter(t.columns,{isDim:!1}),"id"),s=n.map(n.filter(t.columns,{isDim:!0}),"id");if(r.combineMetrics&&i.length>1){a=o.Frame.combinColumns(a,i,"val","metric",s);n.map(n.filter(t.columns,{isDim:!1}),"name")}this.chart.changeData(a)}else this.drawChart(this.props.chartParams,e)},t.prototype.componentDidMount=function(){var e=this.props,t=e.chartParams,r=e.source;this.isValidParams(t,r)&&r&&(this.chart&&this.chart.destroy(),this.drawChart(t,r))},t.prototype.componentWillUnmount=function(){this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML="")},t.prototype.drawChart=function(e,t){var r=this,a=document.createElement("div");a.style.height="100%",s.findDOMNode(this).appendChild(a);var i=a.getBoundingClientRect();if(!e.chartType)return void console.error("Error 101: 图表没有指定类型或类型不合法，请访问ChartParams.md获取类型定义的方案");var l=u(e.chartType),m=this.buildSourceConfig(e),d=n.map(n.filter(e.columns,{isDim:!1}),"id"),f=n.map(n.filter(e.columns,{isDim:!0}),"id"),g=new o.Frame(t);if("comparison"===e.chartType){g.addCol("rate",function(e){return e[d[1]]?e[d[0]]/e[d[1]]-1:0}),m.rate={formatter:function(e){return parseFloat((100*e).toPrecision(3))+"%"}};var y=n.map(n.filter(e.columns,{isDim:!1}),"id"),v=Math.max.apply(null,n.map(y,function(e){return o.Frame.max(g,e)}));y.forEach(function(e){m[e].min=0,m[e].max=v})}else"singleNumber"===e.chartType?f=["tm"]:"funnel"===e.chartType&&(l.appendTip=[d[0]],d=[d[1]]);if(l.combineMetrics&&d.length>1){g=o.Frame.combinColumns(g,d,"val","metric",f),"funnel"===l.shape?f=["metric"]:f.push("metric");var b=n.map(n.filter(e.columns,{isDim:!1}),"name"),T=n.fromPairs(n.zip(d,b));m.metric={type:"cat",formatter:function(e){return T[e]}},m.val={type:"linear",formatter:d.length>1?c.formatNumber:m[d[0]].formatter},d=["val"]}else"MMD"!==l.pos&&(l.margin[3]+=10);if(f.length>1){var x=o.Stat.summary.sum(f[1]+"*"+d[0]);x.init();var C=x.execFrame(g),M=o.Frame.sort(C,d[0]).colArray(f[1]);console.log("sortDim:",M),g=o.Frame.sortBy(g,function(e,t){return console.log(M.indexOf(e[f[1]])),M.indexOf(e[f[1]])<M.indexOf(t[f[1]])?1:-1}),console.log("frame:",g)}var _=i.height;if(m.tm){var P=o.Frame.range(g,"tm");P.length>1&&(m.tm.mask=P[1]-P[0]>=864e5?"mm-dd":"HH:MM");var D=o.Frame.group(g,["tm"]).length;m.tm.tickCount=p(parseInt(i.width/80),D-1)}if("percent"===e.adjust&&(m["..percent"]={formatter:function(e){return parseFloat((100*e).toPrecision(3))+"%"}}),"bar"===e.chartType){var O=Math.max.apply(null,n.map(g.colArray(f[0]),"length"));l.margin[3]=Math.min(120,25+12*O),_=Math.max(15*g.rowCount(),_),m[d[0]].tickCount=4}var E=new o.Chart({container:a,forceFit:!0,height:_||300,plotCfg:{margin:l.margin}});if(E.source(g,m),"MMD"!==l.pos&&d.forEach(function(e){"val"!==e&&E.axis(e,{title:{fill:"#999",textAlign:"center"}})}),void 0!==l.axis&&E.axis(l.axis),void 0!==l.tooltip?E.tooltip(l.tooltip):["line","area"].includes(l.geom)&&E.tooltip({crosshairs:!0}),l.transpose){var w=E.coord("rect").transpose();l.reflect&&w.reflect(l.reflect),l.scale&&w.scale(1,1)}var F=e.adjust;"percent"===F&&(F="stack"),"line"===l.geom?F=void 0:"interval"!==l.geom&&"dodge"===e.adjust&&(F=void 0);var N="MM"===l.pos?d[0]+"*"+d[1]:f[0]+"*"+d[0];l.colorTheme&&!e.colorTheme&&(e.colorTheme=l.colorTheme);var k=E["area"===l.geom&&"dodge"===e.adjust?"line":l.geom](F);if("MMD"===l.pos&&E.line().size(2).position(f[0]+"*"+d[1]).color("#d6dce3").tooltip(d[1]),f.length<2?(N=o.Stat.summary.sum(N),k.position(N),e.colorTheme?k.color("rgb("+e.colorTheme+")"):"MMD"===l.pos&&k.color(o.Theme.defaultColor)):(k.position("percent"===e.adjust?o.Stat.summary.percent(N):N),"MMD"!==l.pos?k.color(f[1]):e.colorTheme&&k.color("rgb("+e.colorTheme+")").size(2)),l.counter||"funnel"===e.chartType){var S=E.point().shape("circle").size(3).position(N).tooltip(!1);f.length>1&&S.color(f[1])}if(l.hideAxis&&E.axis(d[1],!1),l.label){var j=e.aggregates[0];j&&k.label(d[0],{custom:!0,renderer:function(e,t){return parseFloat((100*t.point[d[0]]/j).toPrecision(3))+"%"},offset:5})}if(l.size?k.size(l.size):"MM"===l.pos&&d.length>2&&(k.size(d[2],30,5),E.legend(!1)),l.shape&&k.shape(l.shape),"area"===l.geom&&"stack"!==F){var q=E.area();e.colorTheme?q.color("l(90) 0:rgba("+e.colorTheme+", 0.3) 1:rgba("+e.colorTheme+", 0.1)"):q.opacity(.3),l.shape&&q.shape(l.shape),q.position(N),f.length>1&&"MMD"!==l.pos,q.tooltip("")}if("MM"!==l.pos&&E.legend({position:"bottom"}),"funnel"===e.chartType)k.tooltip(d+"*"+l.appendTip);else if(l.tooltipchange){k.tooltip("rate*"+d[0]);var R=e.granularities[0].interval<864e5;E.tooltip(!0,{map:{title:"rate"}}),E.on("tooltipchange",function(e){e.items[0]=e.items[1],e.items[0].name=h(e.items[0],"tm",R),e.items.length>2&&(e.items[1]=e.items[2],e.items[1].name=h(e.items[1],"tm_",R),e.items.splice(e.items.length-1))})}else"bubble"===e.chartType&&(k.tooltip(d.join("*")+"*"+f[0]),E.tooltip(!0,{map:{title:f[0]}}),E.on("tooltipchange",function(e){e.items.splice(e.items.length-1)}));if(this.props.hasOwnProperty("select")&&this.props.select&&(k.selected(!0,{selectedMode:"single",style:{fill:"#fe9929"}}),"tm"!==f[0])){var z=l.pos?d.slice(0,2):[f[0]];E.on("plotclick",function(e){return r.selectHandler(e,z)}),E.on("itemunselected",function(e){return r.unselectHandler(e,z)})}E.render(),this.chart=E},t.prototype.unselectHandler=function(e,t){},t.prototype.selectHandler=function(e,t){var r=e.shape;if(r){var a=e.geom._attrs.selectedCfg.selectedMode;if(r.get("selected")){var o=r.get("origin"),i=n.pick(o._origin,t);"single"===a?(this.props.select(i,this.lastSelectedShape),this.lastSelectedShape=i):this.props.select(i,null)}else{var o=r.get("origin");this.props.select(null,n.pick(o._origin,t))}}},t.prototype.buildSourceConfig=function(e){var t={},r=u(e.chartType);if(e.columns.forEach(function(e){t[e.id]={alias:e.name,type:e.isDim?"cat":"linear"},e.isRate?(t[e.id].min=0,t[e.id].formatter=function(e){return parseFloat((100*e).toPrecision(3))+"%"}):t[e.id].formatter=c.formatNumber}),t.tm&&(t.tm={tickCount:4,type:"interval"!==r.geom?"time":"timeCat",formatter:function(e){return l.unix(e/1e3).format(e%864e5===576e5?"MM-DD ddd":"HH:mm")}}),"day"===r.counter){var a=n.find(e.columns,{id:"tm"}),o={day:"天",week:"周",month:"月"};t.tm={formatter:function(e){return e>0?""+e+o[a.counter]+"后":"当"+o[a.counter]},tickCount:4,type:"linear"}}return t},t}(i.Component),h=function(e,t,r){var a=e.point._origin[t];return l.unix(a/1e3).format("YYYY-MM-DD ddd"+(r?" hh:mm":""))};t.default=m},function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t){"use strict";t.__esModule=!0,t.formatNumber=function(e){if("number"!=typeof e)return e;var t=["","万","亿","万亿"],r=Math.max(0,Math.min(3,Math.floor(Math.log10(Math.abs(e))/4)));return r<1?Number.isInteger(e)?""+e:parseFloat(e.toPrecision(3)):parseFloat((e*Math.pow(.1,4*r)).toPrecision(3))+t[r]},t.calculateTimeRange=function(e){e||(e="day:8,1");var t=e.split(":"),r=t[0],a=t[1],o=a.split(","),n=o[0],i=o[1];return"day"===r?864e5*parseInt(n,10):"abs"===r?parseInt(i,10)-parseInt(n,10):void 0}},function(e,t){e.exports=o},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(3),n=r(10),i=r(4),s=r(11),c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.render=function(){var e=this.generateChartParams(),t=["comparison","singleNumber"].includes(e.chartType);if("table"===e.chartType)return o.createElement(s.default,{chartParams:e,source:this.context.source,select:this.props.select,selected:this.context.selected,extraColumns:this.props.extraColumns,sortHandler:this.props.sortHandler});if(!this.context.source||!this.context.source.length){var r={"-webkit-box-orient":"vertical","-webkit-box-pack":"center",display:"-webkit-box",height:"100%"},a={color:"#999999",fontSize:16,fontWeight:"bold",textAlign:"center"};return o.createElement("div",{style:r},o.createElement("div",{style:a},"暂无数据"))}return t?o.createElement("div",{className:"gr-chart-wrapper "+e.chartType},o.createElement(n.default,{data:this.context.aggregates,period:this.props.range}),o.createElement(i.default,{chartParams:e,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,selected:this.context.selected})):"singleNumber"===e.chartType?o.createElement("div",{className:"gr-chart-wrapper"},o.createElement(n.default,{data:this.context.aggregates,period:this.props.range}),o.createElement(i.default,{chartParams:e,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,style:{height:"calc(100% - 40px)"},selected:this.context.selected})):o.createElement(i.default,{chartParams:e,source:this.context.source,select:this.props.select,selected:this.context.selected})},t.prototype.generateChartParams=function(){return this.props.hasOwnProperty("chartParams")?this.props.chartParams:{adjust:this.props.adjust,aggregates:this.context.aggregates,chartType:this.props.chartType,colorTheme:this.props.colorTheme,columns:this.context.columns,granularities:this.props.granularities,groupCol:this.props.groupCol}},t}(o.Component);c.contextTypes={aggregates:o.PropTypes.array,columns:o.PropTypes.array,extraColumns:o.PropTypes.any,selectHandler:o.PropTypes.func,selected:o.PropTypes.any,source:o.PropTypes.any},t.default=c},function(e,t,r){"use strict";t.__esModule=!0;var a=r(3),o=r(7),n=function(e){var t=e.data;e.period;return e.data?a.createElement("div",{className:"gr-chart-aggregate-info"},a.createElement("div",{className:"gr-chart-aggregate-inner"},a.createElement("div",{className:"gr-chart-aggregate-num"},o.formatNumber(e.data[0]),a.createElement("span",{className:"suffix"})),t[1]?a.createElement(i,{percent:e.data[0]/e.data[1]-1,period:e.period}):null)):null},i=function(e){return a.createElement("div",{className:"gr-chart-aggregate-percent"},a.createElement("div",{className:"gr-chart-trend-"+(e.percent>0?"up":"down")},a.createElement("svg",{className:"svg-icon"},a.createElement("use",{href:"#icon-"+(e.percent>0?"up":"down")+"-trend"})),a.createElement("span",null,Math.abs(100*e.percent).toPrecision(3)),a.createElement("span",{style:{fontSize:12}},"%")),a.createElement("span",{className:"gr-chart-trend-desc"},e.period?"在最近7天":"相比7天前"))};t.default=n},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(12),n=r(2),i=r(8),s=r(3),c=r(5),l=function(e){return function(t,r){return t[e]>=r[e]?1:-1}};i.locale("zh-cn");var p=function(e,t){return function(r){return null===t?"":r>t?"rgba(255,211,99, "+(r-t)/(e[1]-t)+")":r<t?"rgba(95,182,199, "+(r-t)/(e[0]-t)+")":void 0}},u=function(e,t){if(e){if(t)return(100*e).toPrecision(3)+"%";if(!Number.isInteger(e))return e.toPrecision(3)}return"string"==typeof e?e:null===e?"":void 0===e?void 0:e.toString()},m=function(e,t){return function(r){return{children:u(r,t.isRate),props:{style:{backgroundColor:e(r)}}}}},h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.formatDate=function(e){return i.unix(e/1e3).format("YYYY-MM-DD")},t.getRowKey=function(e,t){return""+t},t.prototype.checkDate=function(e){if("tm"===e.id){var t=n.find(this.props.chartParams.granularities,{id:"tm"});return t.interval&&t.interval>=864e5?function(e){return i.unix(e/1e3).format("YYYY-MM-DD")}:function(e){return i.unix(e/1e3).format("YYYY-MM-DD hh:mm")}}},t.groupFlatter=function(e,t,r,a){return e.reduce(function(e,o){var i=r.indexOf(o[t]);return n.forIn(o,function(r,n){n!==t&&(a.includes(n)?e[n]=o[n]:e[t+"_"+i+"_"+n]=o[n])}),e},{})},t.prototype.render=function(){var e=this,r=this.props.chartParams,a=this.props.source,i=[];if(!a||!r)return null;if(r.groupCol){var u=n.difference(n.map(n.filter(r.columns,"isDim"),"id"),[r.groupCol]),h=n.filter(r.columns,{isDim:!1}),d=n.flatMap(n.unionBy(a,r.groupCol),r.groupCol),f=function(e){return n.values(n.pick(e,u)).join("")},g=n.values(n.groupBy(a,f));a=n.map(g,function(e){return t.groupFlatter(e,r.groupCol,d,u)});var y=new c.Frame(a);i=n.map(u,function(e){return{dataIndex:e,key:e,sorter:l(e),title:n.find(r.columns,{id:e}).name}}),console.log(a);var v=d.map(function(e,t){return{title:e,children:n.map(h,function(e){var a=r.groupCol+"_"+t+"_"+e.id;return{className:"metric",dataIndex:a,key:a,render:m(p(c.Frame.range(y,a),c.Frame.median(y,a)),e),sorter:l(a),title:e.name}})}});i=i.concat(v)}else{var b=new c.Frame(a);i=r.columns.map(function(t){return{className:t.isDim?void 0:"metric",dataIndex:t.id,key:t.id,render:t.isDim?e.checkDate(t):m(p(c.Frame.range(b,t.id),c.Frame.median(b,t.id)),t),sorter:l(t.id),title:t.name}})}if(this.props.hasOwnProperty("extraColumns")&&this.props.extraColumns){var T=this.props.extraColumns;n.find(i,{dataIndex:T.dataIndex})||(T.render||(T.render=function(e){return e}),i=i.concat(T))}return s.createElement(o.Table,{bordered:!0,columns:i,dataSource:a,emptyText:function(){return""},pagination:a.length>19&&{current:1,pageSize:10},rowKey:t.getRowKey,onChange:this.onChange.bind(this)})},t.prototype.onChange=function(e,t,r){n.isEqual(this.lastSorter,r)||(this.props.sortHandler(r),this.lastSorter=r)},t}(s.Component);t.default=h},function(e,t){e.exports=n},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(2),n=r(3),i=r(14);t.HttpStatus={Ok:200,Created:201,NoContent:204,MovedPermanently:301,SeeOther:303,NotModified:304,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,RequestTimeout:408,UnsupportedEntity:422,Locked:423,TooManyRequests:429,InternalServerError:500,NotImplemented:501};var s=function(e){function r(t){var r=e.call(this,t)||this;return r.tryTimes=0,r.state={aggregates:null,columns:null,error:!1,selected:null,source:null},r}return a(r,e),r.prototype.componentWillUnmount=function(){},r.prototype.render=function(){if(this.state.error){var e={"-webkit-box-orient":"vertical","-webkit-box-pack":"center",display:"-webkit-box",height:"100%"},t={color:"#999999",fontSize:16,fontWeight:"bold",textAlign:"center"};return n.createElement("div",{style:e},n.createElement("div",{style:t},"加载失败"))}return this.state.source?n.Children.only(this.props.children):n.createElement("div",{className:"gr-loading-mask"},n.createElement("div",{className:"loading-gif"}))},r.prototype.getChildContext=function(){return{aggregates:this.state.aggregates,columns:this.state.columns,selected:this.state.selected,source:this.state.source}},r.prototype.componentWillReceiveProps=function(e){if(JSON.stringify(this.props.params)!==JSON.stringify(e.params)){if(e.hasOwnProperty("cacheOptions")){var t=i.getChartData(e.params,e.hashKeys);if(t)return void this.setState(t)}this.defaultRequest(e.params,this.afterFetch.bind(this))}},r.prototype.defaultRequest=function(e,r){var a,o=this;a=this.props.hasOwnProperty("sourceUrl")?fetch(this.props.sourceUrl):fetch("/v4/projects/"+project.id+"/chartdata",{body:JSON.stringify(e),credentials:"same-origin",method:"post"}),a.then(function(a){var n=a.status;return n===t.HttpStatus.Ok?(o.tryTimes=0,a.json()):void(n===t.HttpStatus.RequestTimeout&&o.tryTimes<2?(o.tryTimes++,setTimeout(o.defaultRequest.bind(o,e,r),200)):o.setState({error:!0}))}).then(function(e){return r(e)}).catch(function(e){})},r.prototype.componentWillMount=function(){var e=this.props.params;if(this.props.hasOwnProperty("cacheOptions")){var t=i.getChartData(e,this.props.hashKeys);if(t)return void this.setState(t)}this.defaultRequest(e,this.afterFetch.bind(this))},r.prototype.afterFetch=function(e){var t=e.meta.columns,r=o.map(e.meta.columns,"id"),a=e.meta.offset,n=e.data;if(e.meta.offset){var s=6048e5;n=o.zipWith(n.slice(0,a),n.slice(a),function(e,t){return(e||[t[0]+s,null]).concat(t)}),r=r.concat(o.map(r,function(e){return e+"_"})),t[1].name="当前周期",t=t.concat(o.map(t,function(e){return o.assign({},e,{id:e.id+"_",name:e.isDim?void 0:"上一周期"})}))}var c=o.map(n,function(e){return o.zipObject(r,e)});if(this.props.params.attrs&&this.props.params.attrs.isAddFakeMetric){var l=t[t.length-1];l.name+="转化率",l.isRate=!0;var p=l.id;c.forEach(function(e){e["9yGbpp8x"]?e[p]/=e["9yGbpp8x"]:e[p]=void 0})}var u={aggregates:e.meta.aggregates,columns:t,error:!1,source:c};this.props.hasOwnProperty("cacheOptions")&&i.setChartData(this.props.params,u,this.props.hashKeys,this.props.cacheOptions),this.setState(u),this.props.onLoad&&this.props.onLoad(this.state)},r}(n.Component);s.childContextTypes={aggregates:n.PropTypes.array,columns:n.PropTypes.array,selectHandler:n.PropTypes.func,selected:n.PropTypes.any,source:n.PropTypes.any},t.default=s},function(e,t,r){"use strict";function a(e,t){var r="";return r=c(t?t:e)}function o(e){e?delete p[e]:p={}}function n(e,t,r,o){var n="",i=-1,s={};n=a(e,r),o&&!isNaN(o.ttl)&&parseInt(o.ttl,10)!==-1&&60*o.ttl*1e3!==0&&(i=60*o.ttl*1e3+Date.now()),s[n]={ttl:i,chartData:t},l.assign(p,s)}function i(e,t){var r,n="",i=null;return n=a(e,t),p[n]&&(r=p[n].ttl!==-1&&p[n].ttl<Date.now(),r?o(n):i=p[n].chartData),i}function s(){return p}t.__esModule=!0;var c=r(15),l=r(2),p={};t.cleanCache=o,t.setChartData=n,t.getChartData=i,t.getChartDataCache=s},function(e,t){e.exports=i}])});