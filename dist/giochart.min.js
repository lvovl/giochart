!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react"),require("g2"),require("lodash"),require("react-dom"),require("antd"),require("moment")):"function"==typeof define&&define.amd?define(["react","g2","lodash","react-dom","antd","moment"],t):"object"==typeof exports?exports.GIO=t(require("react"),require("g2"),require("lodash"),require("react-dom"),require("antd"),require("moment")):e.GIO=t(e.React,e.g2,e.lodash,e.ReactDOM,e.antd,e.moment)}(this,function(e,t,r,a,o,n){return function(e){function t(a){if(r[a])return r[a].exports;var o=r[a]={exports:{},id:a,loaded:!1};return e[a].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";var a=this&&this.__assign||Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++){t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};t.__esModule=!0;var o=r(2),n=r(3);t.Chart=n.default;var s=r(7);t.ContextListener=s.default;var i=r(12);t.DataSource=i.default;var c=r(9);t.GrTable=c.default;var l=function(e){return o.createElement(i.default,{params:e.params,style:e.style},o.createElement(s.default,{chartType:e.chartType,colorTheme:e.colorTheme,granularities:e.params.granularities,adjust:e.adjust,extraColumns:e.extraColumns}))},p=function(e){var t=e.metrics,r=e.dimensions||[],a=[];e.chartType.includes("dimension")&&(a.push({id:r[0],top:e.top}),r.unshift("tm")),0===r.length&&r.unshift("bar"===e.chartType?"v":"tm"),r.includes("tm")&&a.unshift({id:"tm",interval:e.interval,period:"comparison"===e.chartType?"auto":void 0});var o={aggregateType:"singleNumber"===e.chartType?e.aggregateType:void 0,dimensions:r,filter:e.filter,granularities:a,limit:e.top,metrics:t,orders:e.orders,timeRange:e.timeRange,userTag:e.userTag},n=e.chartType;n.includes("dimension")&&(n=n.replace("dimension","").toLowerCase(),"line"===n&&"total"===e.attrs.subChartType&&(n="area"));var s="total"===e.attrs.subChartType?"stack":"dodge";return{adjust:s,chartType:n,params:o}};t.convertChartParams=p;var u=function(e){return e.chartType?o.createElement(l,a({},e)):o.createElement(l,a({},p(e.params)))};t.default=u},function(t,r){t.exports=e},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(4),n=r(5),s=r(2),i=r(6),c=function(e){var t={combinMetrics:!0,geom:"line"},r={area:{geom:"area"},bar:{geom:"interval",reflect:"y",transpose:!0},bubble:{geom:"point",pos:"MM",combinMetrics:!1},comparison:{geom:"area",pos:"MMD",combinMetrics:!1,hideAxis:!0},dualaxis:{geom:"interval",pos:"MMD",combinMetrics:!1},funnel:{axis:!1,geom:"intervalSymmetric",transpose:!0,scale:!0,shape:"funnel"},line:{geom:"line",size:2},retention:{geom:"line",size:2,counter:"day"},singleNumber:{geom:"area",shape:"smooth",combineMetrics:!1,axis:!1,tooltip:!1},vbar:{geom:"interval"}};return n.merge({},t,r[e])},l=function(e){function t(t){var r=e.call(this)||this;r.lastSelectedShape=null;var a=["#fc5f3a","#fa9d1b","#48a1f9","#9ecefe","#349a38","#7fd182","#d5375f","#ff8ba8","#3e4a9c","#8d9bf3","#525566","#a1a4b3","#25ada1","#8ae1d8","#755920","#dab873","#8d49a4","#da97f1","#f5d360","#ffbd9c"],n=o.Util.mix(!0,{},o.Theme,{animate:!1,axis:{bottom:{labels:{autoRotate:!1},title:null},left:{labels:{autoRotate:!1},title:null}},colors:{default:a,intervalStack:a},defaultColor:"#fc5f3a",shape:{area:{fill:"#fc5f3a",fillOpacity:.3},interval:{fill:"#d5375f"},line:{stroke:"#fc5f3a"}}});return o.Global.setTheme(n),r}return a(t,e),t.prototype.render=function(){return s.createElement("div",{className:"giochart",style:this.props.style})},t.prototype.componentWillReceiveProps=function(e){if(e.source){var t=e.source;if(n.isEmpty(e.selected))n.isEqual(this.props.chartParams,e.chartParams)?this.changeData(t):(this.chart&&this.chart.destroy(),this.drawChart(e.chartParams,t));else{var r=n.map(n.filter(e.chartParams.columns,{isDim:!0}),"id"),a=n.filter(e.selected,function(e){return n.isEmpty(n.pick(e,r))});if(n.isEmpty(a))return;var o=n.filter(t,function(e){return n.some(a,function(t){return n.isMatch(e,t)})});this.changeData(o||t)}}},t.prototype.changeData=function(e){this.chart?this.chart.changeData(e):this.drawChart(this.props.chartParams,e)},t.prototype.componentDidMount=function(){var e=this.props,t=e.chartParams,r=e.source;this.props.source&&(this.chart&&this.chart.destroy(),this.drawChart(t,r))},t.prototype.componentWillUnmount=function(){this.chart&&this.chart.destroy()},t.prototype.drawChart=function(e,t){var r=this,a=document.createElement("div");a.style.height="100%",i.findDOMNode(this).appendChild(a);var s=a.getBoundingClientRect();if(!e.chartType)return void console.error("Error 101: 图表没有指定类型或类型不合法，请访问ChartParams.md获取类型定义的方案");var l=new o.Chart({container:a,forceFit:!0,height:s.height||350,plotCfg:{margin:"singleNumber"===e.chartType?[0,0,0,0]:[10,30,80,50]}}),p=this.buildSourceConfig(e),u=n.map(n.filter(e.columns,{isDim:!1}),"id"),h=n.map(n.filter(e.columns,{isDim:!0}),"id"),m=new o.Frame(t),d=c(e.chartType);if(d.combinMetrics&&u.length>1){m=o.Frame.combinColumns(m,u,"val","metric",h),h.push("metric");var f=n.fromPairs(n.zip(u,name)),g=m.colArray("metric"),y=g.map(function(e){return f[e]});m.colReplace("metric",y)}if(l.source(m,p),void 0!==d.axis&&l.axis(d.axis),void 0!==d.tooltip&&l.tooltip(d.tooltip),d.transpose){var v=l.coord("rect").transpose();d.reflect&&v.reflect(d.reflect)}var b=e.adjust;"line"===d.geom?b=void 0:"interval"!==d.geom&&"dodge"===e.adjust&&(b=void 0);var _=l[d.geom](b),x="MM"===d.pos?u[0]+"*"+u[1]:h[0]+"*"+u[0];if(h.length<2?_.position(o.Stat.summary.sum(x)):(_.position(x),"MMD"!==d.pos&&_.color(h[1])),"MMD"===d.pos&&(l.line().size(2).position(h[0]+"*"+u[1]).color("#e1dac8"),d.hideAxis&&l.axis(u[1],!1)),d.size&&_.size(d.size),d.scale&&_.scale(1,1),d.shape&&_.shape(d.shape),this.props.colorTheme&&_.color("rgb("+this.props.colorTheme+")"),l.tooltip({crosshairs:!0}),l.legend({itemWrap:!1,position:"bottom"}),this.props.hasOwnProperty("select")&&this.props.select&&(_.selected(!0,{selectedMode:"single",style:{fill:"#fe9929"}}),"tm"!==h[0])){var T=d.pos?u.slice(0,2):[h[0]];l.on("plotclick",function(e){return r.selectHandler(e,T)})}l.render(),this.chart=l},t.prototype.selectHandler=function(e,t){var r=e.shape;if(r){var a=e.geom._attrs.selectedCfg.selectedMode;if(r.get("selected")){var o=r.get("origin"),s=n.pick(o._origin,t);"single"===a?(this.props.select(s,this.lastSelectedShape),this.lastSelectedShape=s):this.props.select(s,null)}else{var o=r.get("origin");this.props.select(null,n.pick(o._origin,t))}}},t.prototype.buildSourceConfig=function(e){var t={},r=c(e.chartType);return e.columns.forEach(function(e){t[e.id]={alias:e.name,type:e.isDim?"cat":"linear"},e.isRate&&(t[e.id].formatter=function(e){return(100*e).toPrecision(3)+"%"})}),e.granularities&&e.granularities.forEach(function(e){e.interval&&(t[e.id]={mask:e.interval>=864e5?"mm-dd":"HH:MM",nice:!0,type:"interval"!==r.geom?"time":"timeCat"})}),"day"===r.counter&&(t.tm={formatter:function(e){return e>0?"第"+e+"天":"当天"},type:"linear"}),t},t}(s.Component);t.default=l},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(2),n=r(8),s=r(3),i=r(9),c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.render=function(){var e=this.generateChartParams(),t=["comparison","singleNumber"].includes(e.chartType);return"table"===e.chartType?o.createElement(i.default,{chartParams:e,source:this.context.source,select:this.props.select,extraColumns:this.props.extraColumns}):t?o.createElement("div",{className:"gr-chart-wrapper "+e.chartType},o.createElement(n.default,{data:this.context.aggregates,period:this.props.granularities[0].period>=7}),o.createElement(s.default,{chartParams:e,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select})):"singleNumber"===e.chartType?o.createElement("div",{className:"gr-chart-wrapper"},o.createElement(n.default,{data:this.context.aggregates,period:this.props.granularities[0].period>=7}),o.createElement(s.default,{chartParams:e,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,style:{height:"calc(100% - 40px)"}})):o.createElement(s.default,{chartParams:e,source:this.context.source,select:this.props.select,colorTheme:this.props.colorTheme})},t.prototype.generateChartParams=function(){return this.props.hasOwnProperty("chartParams")?this.props.chartParams:{adjust:this.props.adjust,chartType:this.props.chartType,columns:this.context.columns,granularities:this.props.granularities}},t}(o.Component);c.contextTypes={aggregates:o.PropTypes.array,columns:o.PropTypes.array,extraColumns:o.PropTypes.any,selectHandler:o.PropTypes.func,selected:o.PropTypes.any,source:o.PropTypes.any},t.default=c},function(e,t,r){"use strict";t.__esModule=!0;var a=r(2),o=function(e){var t=[null,"万","亿","万亿"],r=Math.max(0,Math.min(3,Math.floor(Math.log10(Math.abs(e))/4)));return 0===r?e.toPrecision(3):(e*Math.pow(.1,4*r)).toPrecision(3)+t[r]},n=function(e){var t=e.data;e.period;return e.data?a.createElement("div",{className:"gr-chart-aggregate-info"},a.createElement("div",{className:"gr-chart-aggregate-inner"},a.createElement("div",{className:"gr-chart-aggregate-num"},o(e.data[0]),a.createElement("span",{className:"suffix"})),t[1]?a.createElement(s,{percent:e.data[0]/e.data[1]-1,period:e.period}):null)):null},s=function(e){return a.createElement("div",{className:"gr-chart-aggregate-percent"},a.createElement("div",{className:"gr-chart-trend-"+(e.percent>0?"up":"down")},a.createElement("t",null,Math.abs(100*e.percent).toPrecision(3)),a.createElement("t",{style:{fontSize:12}},"%")),a.createElement("span",null,e.period?"在最近7天":"相比7天前"))};t.default=n},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(10),n=r(2),s=r(11),i=r(4),c=function(e){return function(t,r){return t[e]>r[e]?1:-1}},l=function(e,t){return function(r){return r>t?"rgba(255,211,99, "+(r-t)/(e[1]-t)+")":r<t?"rgba(95,182,199, "+(r-t)/(e[0]-t)+")":void 0}},p=function(e,t){return function(e){return{children:e,props:{style:{backgroundColor:t(e)}}}}},u=function(e){return"tm"===e.id?h.formatDate:void 0},h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.formatDate=function(e){return s.unix(e/1e3).format("YYYY-MM-DD")},t.getRowKey=function(e,t){return""+t},t.prototype.render=function(){var e=this.props,r=e.chartParams,a=e.source;if(!a||!r)return null;var s=new i.Frame(a),h=r.columns.map(function(e){return{dataIndex:e.id,key:e.id,render:e.isDim?u(e):p(e,l(i.Frame.range(s,e.id),i.Frame.median(s,e.id))),sorter:c(e.id),title:e.name}});return this.props.hasOwnProperty("extraColumns")&&this.props.extraColumns&&(h=h.concat(this.props.extraColumns)),n.createElement(o.Table,{dataSource:a,columns:h,pagination:a.length>20&&void 0,rowKey:t.getRowKey})},t}(n.Component);t.default=h},function(e,t){e.exports=o},function(e,t){e.exports=n},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();t.__esModule=!0;var o=r(5),n=r(2);t.HttpStatus={Ok:200,Created:201,NoContent:204,MovedPermanently:301,SeeOther:303,NotModified:304,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,RequestTimeout:408,UnsupportedEntity:422,Locked:423,TooManyRequests:429,InternalServerError:500,NotImplemented:501};var s=function(e){function r(t){var r=e.call(this,t)||this;return r.state={aggregates:null,columns:null,isLoaded:!1,selected:null,source:null},r}return a(r,e),r.prototype.render=function(){return n.Children.only(this.props.children)},r.prototype.getChildContext=function(){return{aggregates:this.state.aggregates,columns:this.state.columns,selected:this.state.selected,source:this.state.source}},r.prototype.componentWillReceiveProps=function(e){JSON.stringify(this.props.params)!==JSON.stringify(e.params)&&this.defaultRequest(e.params,this.afterFetch.bind(this))},r.prototype.defaultRequest=function(e,r){var a;a=this.props.hasOwnProperty("sourceUrl")?fetch(this.props.sourceUrl):fetch("/v4/projects/"+project.id+"/chartdata",{body:JSON.stringify(e),credentials:"same-origin",method:"post"}),a.then(function(e){var r=e.status;if(r===t.HttpStatus.Ok)return e.json()}).then(function(e){return r(e)})},r.prototype.componentDidMount=function(){var e=this.props.params;this.defaultRequest(e,this.afterFetch.bind(this))},r.prototype.afterFetch=function(e){var t=e.meta.columns,r=o.map(e.meta.columns,"id"),a=e.meta.offset,n=e.data;if(e.meta.offset){var s=this.props.params.granularities[0].period,i=864e5*s;n=o.zipWith(n.slice(0,a),n.slice(a),function(e,t){return(e||[t[0]+i,null]).concat(t)}),r=r.concat(o.map(r,function(e){return e+"_"})),t[1].name="当前周期",t=t.concat(o.map(t,function(e){return o.assign({},e,{id:e.id+"_",name:e.isDim?void 0:"上一周期"})}))}var c=o.map(n,function(e){return o.zipObject(r,e)});this.setState({aggregates:e.meta.aggregates,isLoaded:!0,columns:t,source:c}),this.props.onLoad&&this.props.onLoad(this.state)},r}(n.Component);s.childContextTypes={aggregates:n.PropTypes.array,columns:n.PropTypes.array,selectHandler:n.PropTypes.func,selected:n.PropTypes.any,source:n.PropTypes.any},t.default=s}])});