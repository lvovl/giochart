!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd"),require("object-hash")):"function"==typeof define&&define.amd?define(["lodash","react","g2","react-dom","moment","antd","object-hash"],e):"object"==typeof exports?exports.GIO=e(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd"),require("object-hash")):t.GIO=e(t.lodash,t.React,t.g2,t.ReactDOM,t.moment,t.antd,t["object-hash"])}(this,function(t,e,r,a,n,o,i){return function(t){function e(a){if(r[a])return r[a].exports;var n=r[a]={exports:{},id:a,loaded:!1};return t[a].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e,r){t.exports=r(1)},function(t,e,r){"use strict";var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),n=this&&this.__assign||Object.assign||function(t){for(var e,r=1,a=arguments.length;r<a;r++){e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t};e.__esModule=!0;var o=r(2),i=r(3),s=r(4);e.Chart=s.default;var c=r(10);e.ContextListener=c.default;var l=r(14);e.DataSource=l.default;var u=r(12);e.GrTable=u.default;var p=function(t){t||(t="day:8,1");var e=t.split(":"),r=e[0],a=e[1],n=a.split(","),o=n[0],i=n[1];return"day"===r?parseInt(o,10)>7:"abs"!==r||parseInt(i,10)-parseInt(o,10)>6048e5},m=function(t){function e(e){var r=t.call(this,e)||this;return r.state={field:null,order:null},r}return a(e,t),e.prototype.render=function(){var t=this.props,e=o.clone(t.params);if(t.extraColumns&&t.params.attrs&&(t.params.attrs.isAddFakeMetric=!1),this.state.field)if(/^dash_/.test(this.state.field))e.orders=[{id:this.state.field,isDim:!0,orderType:"descend"===this.state.order?"desc":"asc"}];else{var r=this.state.field.split("_"),a=r[0],n=r[1],s=o.find(e.metrics,{id:a});e.orders=[{action:n,id:a,isDim:!s,orderType:"descend"===this.state.order?"desc":"asc"}]}return i.createElement(l.default,{params:e,cacheOptions:t.cacheOptions},i.createElement(c.default,{chartType:t.chartType,colorTheme:t.colorTheme,granularities:t.params.granularities,adjust:t.adjust,extraColumns:t.extraColumns,groupCol:t.groupCol,range:p(t.params.timeRange),sortHandler:this.sortHandler.bind(this),isThumb:t.isThumb}))},e.prototype.sortHandler=function(t){this.setState(t)},e}(i.Component),h=function(t){if(!t.chartType)return null;var e=t.metrics,r=t.dimensions||[],a=[];if("singleNumber"===t.chartType&&(r="sum"===t.aggregateType?["tm"]:["tm"].concat(r)),["dimensionLine","dimensionVbar"].includes(t.chartType)&&!r.includes("tm")&&(a=a.concat({id:r[0],top:t.top}),r=["tm"].concat(r)),0===r.length&&(r=["bar"===t.chartType?"v":"tm"].concat(r)),r.includes("tm")&&(a=a.concat({id:"tm",interval:t.interval,period:"comparison"===t.chartType?"auto":void 0})),r.length<1||e.length<1)return null;var n,o;"singleNumber"===t.chartType?(n=!0,o=t.aggregateType||"sum"):["bar","abar"].includes(t.chartType)&&(o="sum",n=!1);var i={aggregation:n,aggregator:o,attrs:t.attrs,dimensions:r,filters:[t.filter],granularities:a,id:t.id,name:t.name,limit:["bar","abar","table"].includes(t.chartType)?t.top:void 0,metrics:e,orders:t.orders,timeRange:t.timeRange,userTag:t.userTag},s=t.chartType;"table"!==s&&i.attrs.rateChange&&(i.attrs.rateChange=void 0),"line"===s&&t.metrics.length<2&&(s="area"),s.includes("dimension")&&(s=s.replace("dimension","").toLowerCase()),"line"===s&&t.attrs.subChartType&&"seperate"!==t.attrs.subChartType&&(s="area"),"abar"===s&&(s="bar"),"funnel"===s&&(i.type="funnel");var c=t.attrs.subChartType||"dodge";"seperate"===c?c="dodge":"total"===c&&(c="stack");var l=t.attrs.colorTheme;return{adjust:c,chartType:s,params:i,colorTheme:l}};e.convertChartParams=h;var d=function(t){if(t.chartType)return i.createElement(m,n({},t));var e=t.params;t.colorTheme&&(e.attrs.colorTheme=t.colorTheme);var r=h(t.params);return r?(t.groupCol&&(r.params.expanded=!0),i.createElement(m,n({extraColumns:t.extraColumns,groupCol:t.groupCol},r,{cacheOptions:t.cacheOptions,isThumb:t.isThumb}))):i.createElement("p",null,"参数不合法")};e.default=d},function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e,r){"use strict";var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();e.__esModule=!0;var n=r(5),o=r(2),i=r(3),s=r(6),c=r(7),l=r(8),u=r(9);u.locale("zh-cn");var p={comparison:function(t,e){t.addCol("rate",function(t){return t[e[1]]?t[e[0]]/t[e[1]]-1:0});var r={rate:{formatter:l.formatPercent,type:"linear"}},a=Math.max.apply(null,o.map(e,function(e){return n.Frame.max(t,e)}));return e.forEach(function(t){r[t]={max:a}}),{frame:t,sourceDef:r}},retention:function(t,e){var r="loss",a=n.Frame.max(t,"retention");t.addCol(r,function(t){return a-t.retention}),e.push(r);var o={loss:{alias:"流失人数",type:"cat",formatter:function(t){return l.formatNumber(Math.abs(t))}},tm:{type:"cat"}};return{frame:t,sourceDef:o}}},m=function(t){function e(e){var r=t.call(this)||this;r.lastSelectedShape=null;var a=n.Util.mix(!0,n.Theme,c.CHARTTHEME);return n.Global.setTheme(a),n.Global.animate=navigator.hardwareConcurrency&&navigator.hardwareConcurrency>7,r}return a(e,t),e.prototype.render=function(){return i.createElement("div",{className:"giochart",style:this.props.style})},e.prototype.isValidParams=function(t,e){if("comparison"===t.chartType&&e.length&&!e[0].tm_)return!1;if("bar"===t.chartType){var r=o.find(t.columns,{isDim:!0});return"tm"!==r.id}return!0},e.prototype.componentWillReceiveProps=function(t){if(!o.isEmpty(t.source)){var e=t.source;if(this.isValidParams(t.chartParams,t.source))if(o.isEmpty(t.selected))JSON.stringify(this.props.chartParams)!==JSON.stringify(t.chartParams)?(this.chart&&(this.chart.destroy(),this.chart.get("container").innerHTML=""),this.drawChart(t.chartParams,e,t.isThumb)):JSON.stringify(e)!==JSON.stringify(this.props.source)&&(this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML=""),this.drawChart(t.chartParams,e,t.isThumb));else{var r=o.map(o.filter(t.chartParams.columns,{isDim:!0}),"id"),a=o.filter(t.selected,function(t){return o.isEmpty(o.pick(t,r))});if(o.isEmpty(a))return;var n=o.filter(e,function(t){return o.some(a,function(e){return o.isMatch(t,e)})});this.changeData(n||e)}}},e.prototype.changeData=function(t){if(this.chart){var e=this.props.chartParams,r=c.CHARTTYPEMAP[e.chartType],a=new n.Frame(t),i=o.map(o.filter(e.columns,{isDim:!1}),"id"),s=o.map(o.filter(e.columns,{isDim:!0}),"id");if(r.combineMetrics&&i.length>1){a=n.Frame.combinColumns(a,i,"val","metric",s);o.map(o.filter(e.columns,{isDim:!1}),"name")}this.chart.changeData(a)}else this.drawChart(this.props.chartParams,t,this.props.isThumb)},e.prototype.componentDidMount=function(){var t=this.props,e=t.chartParams,r=t.isThumb,a=t.source;this.isValidParams(e,a)&&a&&(this.chart&&this.chart.destroy(),this.drawChart(e,a,r))},e.prototype.componentWillUnmount=function(){this.chart&&this.chart.destroy()},e.prototype.washRecord=function(t,e){return n.Frame.filter(t,function(t){return e.every(function(e){return"number"==typeof t[e]})})},e.prototype.combineMetrics=function(t,e,r,a){var i=o.invokeMap(o.groupBy(r,"isDim"),"map",function(t){return t.id}),s=i[0],c=i[1],l="metric",u="val";e.emptyDim&&s.unshift(null);var p=null;if(a){var m=a(t,c);t=m.frame,p=m.sourceDef}if("point"!==e.geom||e.geom.length>1||e.withRate)return{frame:t,metricCols:c,dimCols:s,scales:this.buildScales(r,e.geom,p)};var h=o.map(o.filter(r,{isDim:!1}),"name"),d=o.fromPairs(o.zip(c,h));t=n.Frame.combinColumns(t,c,u,l,s),s.push(l);var f=o.find(r,{id:c})[0].isRate;return r=o.filter(r,{isDim:!0}).concat([{id:"metric",isRate:f,isDim:!1,formatterMap:d},{id:"value",isRate:!0,isDim:!1}]),{frame:t,metricCols:[l],dimCols:s,scales:this.buildScales(r,e.geom,p)}},e.prototype.calculateAdjust=function(t,e){if("percent"===t)return"stack";if("line"!==e&&("interval"===e||"dodge"!==t))return t},e.prototype.calculatePosition=function(t,e,r,a){var o;return o="point"===r.geom?t[0]+"*"+t[1]:e[0]?e[0]+"*"+t[0]:t[0],"percent"===a?n.Stat.summary.percent(o):o},e.prototype.calculateColor=function(t,e){return e?"l(90) 0:rgba("+e+", 0.8) 1:rgba("+e+", 0.1)":t.length>1?t[1]:void 0},e.prototype.calculatePlot=function(t,e,r){var a=[10,30,30,50];if(e.isThumb)return[0,0,0,0];if(e.transpost){var n=Math.max.apply(null,o.map(t.colArray(r[0]),"length"));a[3]=Math.min(145,25+12*n)}return!e.periodOverPeriod&&o.isArray(e.geom)&&(a[1]=50),a},e.prototype.drawChart=function(t,e,r){void 0===r&&(r=!1);var a=document.createElement("div");a.style.height="100%",s.findDOMNode(this).appendChild(a);var i=a.getBoundingClientRect(),u=c.CHARTTYPEMAP[t.chartType],m=new n.Frame(e),h=t.chartType,d=this.combineMetrics(m,u,t.columns,p[h]),f=d.metricCols,g=d.dimCols,y=d.scales;m=this.washRecord(m,f),y.tm&&(y.tm.tickInterval=l.countTickCount(m,i.width)),"percent"===t.adjust&&(y["..percent"]={formatter:l.formatPercent,type:"linear"});var v=0;if(g.length>1&&!o.isArray(u.geom)){var _=m.colArray(g[1]),b=this.drawLegend(g[1],o.uniq(_),y[g[1]],!!u.legendSingleMode,"top"===u.legendPosition?t.aggregator.values:null);"top"===u.legendPosition?(b.className="giochart-legends top-legends",s.findDOMNode(this).insertBefore(b,a)):s.findDOMNode(this).appendChild(b),v=b.getBoundingClientRect().height}a.style.height="calc( 100% - "+v+"px)";var T=this.calculateAdjust(t.adjust,u.geom),C=this.calculatePosition(f,g,u,t.adjust),x=this.calculateColor(g,t.colorTheme||u.colorTheme),w=i.height-v;u.transpose&&(w=Math.max(15*m.rowCount(),w));var P=new n.Chart({container:a,forceFit:!0,height:w||300,plotCfg:{margin:this.calculatePlot(m,u,g)}});P.source(m,y),P.axis(!u.isThumb&&u.axis);var k;k=u.coord?P.coord(u.coord,{radius:1,inner:.7}):P.coord("rect"),u.transpose&&(k.transpose(u.transpose),u.reflect&&k.reflect(u.reflect));var D=o.isArray(u.geom)?u.geom[0]:u.geom;if(o.isArray(u.geom)&&u.periodOverPeriod&&(P[u.geom[1]]().position(g[0]+"*"+f[1]).color("#ccc"),P.axis(f[0],!1)),u.legendSingleMode&&g.length>1){var _=m.colArray(g[1]);P.filter(g[1],[_[0]])}var E=P[D](T);if("area"===D&&g.length<2&&E.size(2),o.isArray(u.geom)&&!u.periodOverPeriod&&P[u.geom[1]]().position(g[0]+"*"+f[1]).color("#ccc"),u.shape&&("string"==typeof u.shape?E.shape(u.shape):E.shape(g[1],u.shape)),E.position(C),x&&E.color(x),"point"===u.geom&&f.length>2&&E.size(f[2],40,2),u.label&&E.label(f[0],{offset:-5}),u.isThumb&&u.tooltip&&E.tooltip(!u.isThumb&&u.tooltip),P.legend(o.isArray(u.geom)),u.aggregates){var M=y[f[0]];P.guide().html([-5.5,0],'<div style="text-align:center;white-space: nowrap;"><p style="color:#999;font-size:12px;">总'+M.alias+'</p><p style="color:#333;font-size:22px;">'+M.formatter(t.aggregates[0])+"</p></div>")}P.render(),this.chart=P},e.prototype.drawLegend=function(t,e,r,a,o){var i=this,s=document.createElement("div");s.className="giochart-legends";var c=n.Global.colors.default,u=document.createElement("ul");if(u.innerHTML=e.map(function(t,e){return'<li data-val="'+t+'" '+('title="'+(r.formatter?r.formatter(t):t)+'" class="'+(a&&e>0?"disabled":"")+'">')+('<svg fill="'+c[e%c.length]+'"><rect width="11" height="11" zIndex="3"></rect></svg>')+(r.formatter?r.formatter(t):t)+(o?"：<span>"+l.formatPercent(o[e])+"</span>":"")+"</li>"}).join(""),s.appendChild(u),this.legends=e.map(function(t,e){return{color:n.Global.colors.default[e],dotDom:s.querySelector("li:nth-child("+(1+e)+")"),isChecked:!(a&&e>0),name:t}}),u.addEventListener("click",function(e){for(var r=e.target,n=e.currentTarget;n.contains(r);){var o=r.getAttribute("data-val");if(o)return e.stopPropagation(),void i.filter(t,o,a);r=r.parentNode}}),o)return s;var p=document.createElement("div");p.className="giochart-legend-scroller",p.innerHTML='<span><i class="anticon anticon-caret-up" data-action="up"></i></span><span><i class="anticon anticon-caret-down" data-action="down"></i></span>',s.appendChild(p);var m=0;p.addEventListener("click",function(t){t.stopPropagation();var e=t.target,r=u.getBoundingClientRect().height,a=e.getAttribute("data-action");"up"===a&&m>19?(m-=20,u.style.transform="translate(0, "+-m+"px)"):"down"===a&&r>m+70&&(m+=20,u.style.transform="translate(0, "+-m+"px)")}),document.body.addEventListener("resize",function(t){var e=s.getBoundingClientRect().height,r=u.getBoundingClientRect().height;s.style.textAlign=!a&&e<21?"center":"left",p.style.display=r>70?"block":"none"});var h=s.getBoundingClientRect().height,d=u.getBoundingClientRect().height;return u.style.textAlign=h<25?"center":"left",p.style.display=d>70?"block":"none",s},e.prototype.filter=function(t,e,r){var a=o.find(this.legends,{name:e}),n=[];a.isChecked&&r||(a.isChecked=!a.isChecked,this.legends.forEach(function(t){(r?t.name===a.name:t.isChecked)?(t.isChecked=!0,t.dotDom.className="",n.push(t.name)):(t.dotDom.className="disabled",t.isChecked=!1)}),this.chart.filter(t,n),this.props.onFiltered&&this.props.onFiltered(t,n),this.chart.repaint())},e.prototype.unselectHandler=function(t,e){},e.prototype.selectHandler=function(t,e){var r=t.shape;if(r){t.geom._attrs.selectedCfg.selectedMode;if(r.get("selected")){var a=r.get("origin");o.pick(a._origin,e)}else var a=r.get("origin")}},e.prototype.buildScales=function(t,e,r){var a={};return t.forEach(function(t){"tm"===t.id?a.tm={tickCount:4,type:"interval"===e?"timeCat":"time",formatter:function(t){return u.unix(t/1e3).format(t%864e5===576e5?"MM-DD ddd":"HH:mm")}}:t.isDim?a[t.id]={alias:t.name,type:"cat"}:a[t.id]={alias:t.name,type:"linear",min:0,formatter:t.isRate?l.formatPercent:l.formatNumber,tickCount:4}}),r?o.defaultsDeep(r,a):a},e}(i.Component);e.default=m},function(t,e){t.exports=r},function(t,e){t.exports=a},function(t,e){"use strict";e.__esModule=!0,e.CHARTTYPEMAP={area:{geom:"area",colorTheme:"252, 95, 58"},bar:{geom:"interval",reflect:"y",transpose:!0,label:!0},bubble:{geom:"point",shape:"circle"},comparison:{geom:["area","line"],periodOverPeriod:!0,colorTheme:"252, 95, 58"},dualaxis:{geom:["interval","line"]},funnel:{geom:"line",withRate:!0},funnelChart:{geom:"line",withRate:!0,legendPosition:"top"},line:{geom:"line"},retention:{geom:"interval",shape:["stroke","hollowRect"],withRate:!0},retentionTrend:{geom:"line",withRate:!0},singleNumber:{geom:"area",shape:"smooth",isThumb:!0,colorTheme:"252, 95, 58"},vbar:{geom:"interval"},donut:{geom:"interval",emptyDim:!0,coord:"theta",aggregates:!0}};var r=["#5FB6C7","#FFD159","#C9C77C","#FA7413","#D6DCE3","#6F5D45","#FDF0A1","#bf1f41","#A1EBDE","#CBBD8C","#B96285","#8a73c9","#005a03","#320096","#673000","#2d396b"];e.CHARTTHEME={animate:!1,axis:{bottom:{labels:{autoRotate:!1},title:null},left:{labels:{autoRotate:!1},line:null,tickLine:{lineWidth:0,stroke:"#fcc"},title:null},right:{labels:{autoRotate:!1},title:null}},colors:{default:r,intervalStack:r},defaultColor:"#5FB6C7",legend:!1,shape:{area:{fill:"#5FB6C7"},hollowPoint:{fill:"#5FB6C7"},interval:{fill:"#abce5b",fillOpacity:1,stroke:"#5FB6C7"},line:{stroke:"#5FB6C7",lineWidth:2},point:{fill:"#5FB6C7",fillOpacity:.5}},tooltip:{tooltipMarker:{stroke:"#5FB6C7"}}}},function(t,e,r){"use strict";e.__esModule=!0;var a=r(5),n=r(2);e.formatNumber=function(t){if("number"!=typeof t)return t;var e=["","万","亿","万亿"],r=Math.max(0,Math.min(3,Math.floor(Math.log10(Math.abs(t))/4)));return r<1?Number.isInteger(t)?""+t:parseFloat(t.toPrecision(3)).toString():parseFloat((t*Math.pow(.1,4*r)).toPrecision(3))+e[r]},e.formatPercent=function(t){return"number"!=typeof t?t:t?0<t&&t<.001?"< 0.1%":0>t&&t>.001?"> -0.1%":parseFloat((100*t).toPrecision(3))+"%":"0%"},e.calculateTimeRange=function(t){t||(t="day:8,1");var e=t.split(":"),r=e[0],a=e[1],n=a.split(","),o=n[0],i=n[1];return"day"===r?864e5*parseInt(o,10):"abs"===r?parseInt(i,10)-parseInt(o,10):void 0},e.countTickCount=function(t,e){var r=(a.Frame.range(t,"tm"),a.Frame.group(t,["tm"]).length,a.Frame.range(t,"tm")),n=r[0],o=r[1],i=(o-n)/e*80;return o-n>864e5?864e5*Math.ceil(i/864e5):36e5*Math.ceil(i/36e5)},e.retentionSourceSelector=function(t,e,r){var a=(r?n.reject:n.filter)(t,{tm:0});if(r){var o=n.map(a,function(t){return n.pick(t,e.concat(["retention_1","retention_rate_1","retention_7","retention_rate_7","retention_14","retention_rate_14"]))});return o}var i=n.map(a,function(t){var r=n.pick(t,e),a=n.transform(t,function(t,e,r){var a=r.match(/^(retention(?:_rate)?)_(\d+)$/);if(a){var n=parseInt(a[2],10);t[n]||(t[n]={}),t[n][a[1]]=e}},[]);return n.map(a,function(t,e){return n.assign(t,r,{tm:e})})});return n.flatten(i)}},function(t,e){t.exports=n},function(t,e,r){"use strict";var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();e.__esModule=!0;var n=r(3),o=r(11),i=r(4),s=r(12),c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return a(e,t),e.prototype.render=function(){var t=this.generateChartParams(),e=["comparison","singleNumber"].includes(t.chartType);if("table"===t.chartType)return n.createElement(s.default,{chartParams:t,extraColumns:this.props.extraColumns,source:this.context.source,select:this.props.select,selected:this.context.selected,sortHandler:this.props.sortHandler,startTime:this.context.startTime,trackWords:this.context.trackWords});if(!this.context.source||!this.context.source.length){var r={"-webkit-box-orient":"vertical","-webkit-box-pack":"center",display:"-webkit-box",height:"100%"},a={color:"#999999",fontSize:16,fontWeight:200,textAlign:"center"};return n.createElement("div",{style:r},n.createElement("div",{style:a},"暂无数据"))}if(e){var c=!!(this.context.columns&&this.context.columns.length>1&&this.context.columns[1].isRate);return n.createElement("div",{className:"gr-chart-wrapper "+t.chartType},n.createElement(o.default,{data:this.context.aggregator.values,period:this.props.range,isRate:c}),n.createElement(i.default,{chartParams:t,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb}))}return"singleNumber"===t.chartType?n.createElement("div",{className:"gr-chart-wrapper"},n.createElement(o.default,{data:this.context.aggregator.values,period:this.props.range}),n.createElement(i.default,{chartParams:t,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,style:{height:"calc(100% - 40px)"},selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb})):n.createElement(i.default,{chartParams:t,source:this.context.source,select:this.props.select,selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb})},e.prototype.generateChartParams=function(){return this.props.hasOwnProperty("chartParams")?this.props.chartParams:{adjust:this.props.adjust,aggregator:this.context.aggregator,chartType:this.props.chartType,colorTheme:this.props.colorTheme,columns:this.context.columns,granularities:this.props.granularities,groupCol:this.props.groupCol}},e}(n.Component);c.contextTypes={aggregator:n.PropTypes.any,columns:n.PropTypes.array,extraColumns:n.PropTypes.any,selectHandler:n.PropTypes.func,selected:n.PropTypes.any,source:n.PropTypes.any,startTime:n.PropTypes.number,trackWords:n.PropTypes.any},e.default=c},function(t,e,r){"use strict";e.__esModule=!0;var a=r(3),n=r(8),o=function(t){var e=t.data;t.period;return t.data?a.createElement("div",{className:"gr-chart-aggregate-info"},a.createElement("div",{className:"gr-chart-aggregate-inner"},a.createElement("div",{className:"gr-chart-aggregate-num"},t.isRate?n.formatPercent(t.data[0]):n.formatNumber(t.data[0]),a.createElement("span",{className:"suffix"})),e[1]?a.createElement(i,{percent:t.data[0]/t.data[1]-1,period:t.period}):null)):null},i=function(t){return a.createElement("div",{className:"gr-chart-aggregate-percent"},a.createElement("div",{className:"gr-chart-trend-"+(t.percent>0?"up":"down")},a.createElement("svg",{className:"svg-icon"},a.createElement("use",{href:"#icon-"+(t.percent>0?"up":"down")+"-trend"})),a.createElement("span",null,n.formatPercent(Math.abs(t.percent)).slice(0,-1)),a.createElement("span",{style:{fontSize:12}},"%")),a.createElement("span",{className:"gr-chart-trend-desc"},t.period?"相比上周期":"相比7天前"))};e.default=o},function(t,e,r){"use strict";var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();e.__esModule=!0;var n=r(13),o=r(2),i=r(9),s=r(3),c=r(5),l=n.Table,u=function(t){return function(e,r){return e[t]>=r[t]?1:-1}};i.locale("zh-cn");var p=function(t,e){return function(r){return null===e?"":r>e?"rgba(255,211,99, "+.5*(r-e)/(t[1]-e)+")":r<e?"rgba(95,182,199, "+.5*(r-e)/(t[0]-e)+")":void 0}},m=function(t,e){if(t){if(e)return(100*t).toPrecision(3)+"%";if(!Number.isInteger(t))return t.toPrecision(3)}return"string"==typeof t?t:null===t?"":void 0===t?void 0:t.toString()},h=function(t,e){return function(r){return{children:m(r,e.isRate),props:{style:{backgroundColor:t(r)}}}}},d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.lastSorter={},e}return a(e,t),e.formatDate=function(t){return i.unix(t/1e3).format("YYYY-MM-DD")},e.getRowKey=function(t,e){return""+e},e.prototype.checkDate=function(t){if("tm"===t.id){var e=o.find(this.props.chartParams.granularities,{id:"tm"});return e.interval&&e.interval>=864e5?function(t){return i.unix(t/1e3).format("YYYY-MM-DD")}:function(t){return i.unix(t/1e3).format("YYYY-MM-DD HH:mm")}}},e.groupFlatter=function(t,e,r,a){return t.reduce(function(t,n){var i=r.indexOf(n[e]);return o.forIn(n,function(r,o){o!==e&&(a.includes(o)?t[o]=n[o]:t[e+"_"+i+"_"+o]=n[o])}),t},{})},e.prototype.render=function(){var t=this,r=this.props.chartParams,a=this.props.source,n=[];try{if(!a||!r)return null;if(r.groupCol){var i=o.difference(o.map(o.filter(r.columns,"isDim"),"id"),[r.groupCol]),m=o.filter(r.columns,{isDim:!1}),d=o.flatMap(o.unionBy(a,r.groupCol),r.groupCol),f=function(t){return o.values(o.pick(t,i)).join("")},g=o.values(o.groupBy(a,f));a=o.map(g,function(t){return e.groupFlatter(t,r.groupCol,d,i)});var y=new c.Frame(a);n=o.map(i,function(t){return{dataIndex:t,key:t,sorter:u(t),title:o.find(r.columns,{id:t}).name}});var v=d.map(function(t,e){return{title:t,children:o.map(m,function(t){var a=r.groupCol+"_"+e+"_"+t.id;return{className:"metric",dataIndex:a,key:a,render:h(p(c.Frame.range(y,a),c.Frame.median(y,a)),t),sorter:u(a),title:t.name}})}});n=n.concat(v)}else{var _=new c.Frame(a);n=r.columns.map(function(e,r){return{className:e.isDim?void 0:"metric",dataIndex:e.id,key:e.id+"_"+r,render:e.isDim?t.checkDate(e):h(p(c.Frame.range(_,e.id),c.Frame.median(_,e.id)),e),sorter:u(e.id),title:e.name}})}if(this.props.hasOwnProperty("extraColumns")&&this.props.extraColumns){var b=this.props.extraColumns;o.find(n,{dataIndex:b.dataIndex})||(b.render||(b.render=function(t){return t}),n=n.concat(b))}return s.createElement(l,{bordered:!0,columns:n,dataSource:a,emptyText:function(){return""},pagination:a.length>10&&{current:1,pageSize:10},rowKey:e.getRowKey,onChange:this.onChange.bind(this),ref:this.onLoad.bind(this)})}catch(t){return this.track("report_render_fail"),null}},e.prototype.onLoad=function(t){t&&this.track("report_render_success")},e.prototype.track=function(t){try{var e=window._vds;e.track(t,{project_id:window.project.id,chart_name:this.props.trackWords.name,board_name:this.props.trackWords.board_name,report_load_time:Date.now()-this.props.startTime,channel_name:this.props.trackWords.channel_name})}catch(t){return}},e.prototype.onChange=function(t,e,r){o.isEqual(this.lastSorter,r)||(this.props.sortHandler(r),this.lastSorter=r)},e}(s.Component);e.default=d},function(t,e){t.exports=o},function(t,e,r){"use strict";var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();e.__esModule=!0;var n=r(2),o=r(3),i=r(15);e.HttpStatus={Ok:200,Created:201,NoContent:204,MovedPermanently:301,SeeOther:303,NotModified:304,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,RequestTimeout:408,UnsupportedEntity:422,Locked:423,TooManyRequests:429,InternalServerError:500,NotImplemented:501};var s=function(t){var e="";try{e=JSON.parse(t),e=e.message,"string"==typeof e&&(e=JSON.parse(e),e=e.reason)}catch(t){e="网络错误"}return e},c=function(t){function r(e){var r=t.call(this,e)||this;return r.tryTimes=0,r.startTime=0,r.trackWords={board_name:"",channel_name:"",name:""},r.xhr="",r.state={aggregator:null,columns:null,error:!1,loading:!0,selected:null,source:null},r}return a(r,t),r.prototype.render=function(){if(this.state.error){var t={101:"数据加载失败",102:"业务计算超时"};return o.createElement("div",{className:"chart-error"},o.createElement("div",null,"抱歉，",t[this.state.error],o.createElement("br",null),"请稍后重试"))}return this.state.loading?o.createElement("div",{className:"gr-loading-mask"},o.createElement("div",{className:"loading-gif"})):o.Children.only(this.props.children)},r.prototype.getChildContext=function(){return{aggregator:this.state.aggregator,columns:this.state.columns,selected:this.state.selected,source:this.state.source,startTime:this.startTime,trackWords:this.trackWords}},r.prototype.componentWillReceiveProps=function(t){if(!n.isEqual(this.props.params,t.params)){if(t.hasOwnProperty("cacheOptions")){var e=i.getChartData(t.params,t.hashKeys);if(e)return void this.setState(e)}this.startTime=Date.now(),this.setState({loading:!0}),this.defaultRequest(t.params,this.afterFetch.bind(this))}},r.prototype.defaultRequest=function(t,r){var a=this;this.xhr&&this.xhr.abort();var n=new XMLHttpRequest;this.props.hasOwnProperty("sourceUrl")?(n.open("get",this.props.sourceUrl,!0),n.send(null)):(n.open("post",window.gateway+"/_private/v4/projects/"+project.id+"/chartdata",!0),n.timeout=6e4,n.withCredentials=!0,n.setRequestHeader("credentials","include"),n.setRequestHeader("accept","application/json"),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(t))),n.onreadystatechange=function(){if(4===n.readyState)if(n.status===e.HttpStatus.Ok){var o=JSON.parse(n.responseText);r(o,t)}else if(n.status===e.HttpStatus.RequestTimeout&&a.tryTimes<2)a.tryTimes++,setTimeout(a.defaultRequest.bind(a,t,r),200);else{a.setState({error:n.status===e.HttpStatus.RequestTimeout?102:101,loading:!1});var i=window._vds;i&&i.track("report_load_fail",{project_id:window.accountId,project_name:window.project.name,chart_name:t.name,board_name:a.trackWords.board_name,report_load_time:Date.now()-a.startTime,channel_name:a.trackWords.channel_name,error_msg:s(n.responseText)})}},n.ontimeout=function(e){n.abort&&n.abort(),a.setState({error:102,loading:!1});var r=window._vds;r&&r.track&&r.track("report_load_fail",{project_id:window.accountId,project_name:window.project.name,chart_name:t.name,board_name:a.trackWords.board_name,report_load_time:Date.now()-a.startTime,channel_name:a.trackWords.channel_name,error_msg:s(n.responseText)})}},r.prototype.componentWillMount=function(){var t=this.props.params;try{var e=location.pathname.match(/\/projects\/\w{8}\/([^\/]+)(?:\/([^\/]+))?/);e&&e.length>2&&(this.trackWords={channel_name:e[1],board_name:e[2],name:t.name})}catch(t){}if(this.props.hasOwnProperty("cacheOptions")){var r=i.getChartData(t,this.props.hashKeys);if(r)return void this.setState(r)}this.startTime=Date.now(),this.defaultRequest(t,this.afterFetch.bind(this))},r.prototype.componentWillUnmount=function(){this.xhr&&this.xhr.abort()},r.prototype.afterFetch=function(t,e){if(this.xhr=null,n.isEqual(e,this.props.params)){var r=t.meta.columns;r.forEach(function(t){!t.isDim&&t.metricId&&t.metricId.action&&(t.id+="_"+t.metricId.action||"")});var a=n.map(r,"id"),o=t.meta.offset,s=t.data;if(void 0!==t.meta.offset){var c=6048e5;s=n.zipWith(s.slice(0,o),s.slice(o),function(t,e){return(t||[e[0]+c,null]).concat(e)}),a=a.concat(n.map(a,function(t){return t+"_"})),r[1].name="当前周期",r=r.concat(n.map(r,function(t){return n.assign({},t,{id:t.id+"_",name:t.isDim?void 0:"上一周期"})}))}var l=n.map(s,function(t){return n.zipObject(a,t)});if(e.attrs&&e.attrs.isAddFakeMetric){var u=r[r.length-1];u.name+="转化率",u.isRate=!0;var p=u.id;l.forEach(function(t){t["9yGbpp8x"]?t[p]/=t["9yGbpp8x"]:t[p]=void 0})}if(!l||0===l.length)try{var m=window._vds;m.track("report_no_data",{project_id:window.accountId,project_name:window.project.name,chart_name:e.name,board_name:this.trackWords.board_name,report_load_time:Date.now()-this.startTime,channel_name:this.trackWords.channel_name,params:JSON.stringify(e)})}catch(t){}var h={aggregator:t.meta.aggregator||null,columns:r,error:!1,loading:!1,source:l};this.props.hasOwnProperty("cacheOptions")&&i.setChartData(e,h,this.props.hashKeys,this.props.cacheOptions),this.setState(h),this.props.onLoad&&this.props.onLoad(this.state)}},r}(o.Component);c.childContextTypes={aggregator:o.PropTypes.any,columns:o.PropTypes.array,selectHandler:o.PropTypes.func,selected:o.PropTypes.any,source:o.PropTypes.any,startTime:o.PropTypes.number,trackWords:o.PropTypes.any},e.default=c},function(t,e,r){"use strict";function a(t,e){var r="";return r=c(e?e:t)}function n(t){t?delete u[t]:u={}}function o(t,e,r,n){var o=a(t,r),i=-1,s={};n&&!isNaN(n.ttl)&&parseInt(n.ttl,10)!==-1&&60*n.ttl*1e3!==0&&(i=60*n.ttl*1e3+Date.now()),s[o]={ttl:i,chartData:e},l.assign(u,s)}function i(t,e){var r,o="",i=null;return o=a(t,e),u[o]&&(r=u[o].ttl!==-1&&u[o].ttl<Date.now(),r?n(o):i=u[o].chartData),i}function s(){return u}e.__esModule=!0;var c=r(16),l=r(2),u={};e.cleanCache=n,e.setChartData=o,e.getChartData=i,e.getChartDataCache=s},function(t,e){t.exports=i}])});